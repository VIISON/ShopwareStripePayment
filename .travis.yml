---

# This .travis.yml has been auto-generated by
# <https://github.com/pickware/EverythingShopware/blob/484c0d1ba4933007fb8bd780f7808b907b6184ff/scripts/transitions/2018/2018-03-23-travis-testing/upgrade.sh>.

language: php

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/ci/cache

pickware:
  base_plugin_def: &pickware_base_plugin
    before_install:
      - nvm install 11
      - git clone --branch api-v1 git@github.com:VIISON/travis-ci-tools.git "$HOME"/ci-tools

  lint_plugin_def: &pickware_lint_plugin
    <<: *pickware_base_plugin
    script:
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- lint.sh .'
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- run-hooks.sh after'
    addons:
      apt:
        packages:
          - parallel

  test_plugin_no_mysql_svc_def: &pickware_test_no_mysql_svc_plugin
    <<: *pickware_base_plugin
    install:
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- have-shopware.sh'
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- have-plugins.sh from-dir:.'
    script:
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- test-plugins.sh'
      - '"$HOME"/ci-tools/shopware-plugins/in-travis.sh -- run-hooks.sh after'
    addons:
      apt:
        packages:
          - ant
          - nginx
          - parallel

  test_plugin_def: &pickware_test_plugin
    <<: *pickware_test_no_mysql_svc_plugin
    services:
      - mysql

  # Every build on master, or a PR, or any Full Build, or any Release Build, or any Nightly.
  if_auto_build_def: &pickware_if_auto_build
    if: |
      (
        not (
          tag is not present
          && commit_message =~ /^(?i)Prepares?\s+release\s+/
          && branch = master
          && type = push
        )
      ) && (
        branch = master
        || type = pull_request
        || type = api
        || tag is present
        || commit_message =~ /^(?i)Prepares?\s+release\s+/
        || commit_message =~ /^CI-Full-Build:\s*(?:(?i)1|true|on|yes)\s*$/
        || env(CI_FORCE_FULL_BUILD) = 1
        || env(CI_IS_RELEASE_BUILD) = 1
        || type = cron
        || commit_message =~ /^CI-Nightly:\s*(?:(?i)1|true|on|yes)\s*$/
        || env(CI_IS_NIGHTLY_BUILD) = 1
      )

  # Every Full Build, or any Release Build, or any Nightly.
  if_full_build_def: &pickware_if_full_build
    if: |
      (
        not (
          tag is not present
          && commit_message =~ /^(?i)Prepares?\s+release\s+/
          && branch = master
          && type = push
        )
      ) && (
        tag is present
        || commit_message =~ /^(?i)Prepares?\s+release\s+/
        || commit_message =~ /^CI-Full-Build:\s*(?:(?i)1|true|on|yes)\s*$/
        || env(CI_FORCE_FULL_BUILD) = 1
        || env(CI_IS_RELEASE_BUILD) = 1
        || type = cron
        || commit_message =~ /^CI-Nightly:\s*(?:(?i)1|true|on|yes)\s*$/
        || env(CI_IS_NIGHTLY_BUILD) = 1
      )

  if_nightly_def: &pickware_if_nightly
    if: |
      type = cron
      || commit_message =~ /^CI-Nightly:\s*(?:(?i)1|true|on|yes)\s*$/
      || env(CI_IS_NIGHTLY_BUILD) = 1

stages:
  - &pickware_stage_lint_and_test 'Linting and tests'

jobs:
  include:
    - stage: *pickware_stage_lint_and_test
      name: "Lint with PHP 5.6.40"
      php: "5.6.40"
      <<: *pickware_lint_plugin
      <<: *pickware_if_auto_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware 5.7 with PHP 8.0.2"
      env:
        - SHOPWARE_GIT_REF=5.7
        - CI_SHOPWARE_FORCE_GIT_DESCRIBE_MATCH=v5.7.*
        - CI_SHOPWARE_FORCE_VERSION=5.7.0
        - CI_MAIN_BUILD_WITH_EXTRA_ACTIONS=1
      php: "8.0.2"
      <<: *pickware_test_plugin
      <<: *pickware_if_auto_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.6.9 with PHP 7.3.23"
      env:
        - SHOPWARE_GIT_REF=v5.6.9
      php: "7.3.23"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.5.10 with PHP 7.2.34"
      env:
        - SHOPWARE_GIT_REF=v5.5.10
      php: "7.2.34"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.4.6 with PHP 7.0.33"
      env:
        - SHOPWARE_GIT_REF=v5.4.6
        - CI_COMPOSER_MAJOR_VERSION=1
      php: "7.0.33"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.3.7 with PHP 7.0.33"
      env:
        - SHOPWARE_GIT_REF=v5.3.7
      php: "7.0.33"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.2.27 with PHP 7.0.33"
      env:
        - SHOPWARE_GIT_REF=v5.2.27
      php: "7.0.33"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware v5.2.0 with PHP 5.6.40"
      env:
        - SHOPWARE_GIT_REF=v5.2.0
      php: "5.6.40"
      <<: *pickware_test_plugin
      <<: *pickware_if_full_build

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware 5.7 branch with PHP nightly (nightly)"
      env:
        - SHOPWARE_GIT_REF=5.7
        - CI_SHOPWARE_FORCE_GIT_DESCRIBE_MATCH=v5.7.*
        - CI_SHOPWARE_FORCE_VERSION=5.7.0
      php: "nightly"
      <<: *pickware_test_plugin
      <<: *pickware_if_nightly

  allow_failures:

    - stage: *pickware_stage_lint_and_test
      name: "Test on Shopware 5.7 branch with PHP nightly (nightly)"
      env:
        - SHOPWARE_GIT_REF=5.7
        - CI_SHOPWARE_FORCE_GIT_DESCRIBE_MATCH=v5.7.*
        - CI_SHOPWARE_FORCE_VERSION=5.7.0
      php: "nightly"
      <<: *pickware_test_plugin
      <<: *pickware_if_nightly

notifications:
  webhooks:
    - https://viison:vegas2017@pickwaremetrics.herokuapp.com/webhooks/travis
